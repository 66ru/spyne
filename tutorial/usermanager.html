

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>User Manager &mdash; rpclib v2.3.1-beta documentation</title>
    <link rel="stylesheet" href="../static/default.css" type="text/css" />
    <link rel="stylesheet" href="../static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.3.1-beta',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../static/jquery.js"></script>
    <script type="text/javascript" src="../static/underscore.js"></script>
    <script type="text/javascript" src="../static/doctools.js"></script>
    <link rel="top" title="rpclib v2.3.1-beta documentation" href="../index.html" />
    <link rel="up" title="Rpclib Tutorials" href="index.html" />
    <link rel="next" title="SQLAlchemy Integration" href="sqlalchemy.html" />
    <link rel="prev" title="Hello World" href="helloworld.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="sqlalchemy.html" title="SQLAlchemy Integration"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="helloworld.html" title="Hello World"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">rpclib v2.3.1-beta documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Rpclib Tutorials</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="user-manager">
<span id="tutorial-user-manager"></span><h1>User Manager<a class="headerlink" href="#user-manager" title="Permalink to this headline">Â¶</a></h1>
<p>Let&#8217;s try a more complicated example than just strings and integers!
The following is an simple example using complex, nested data. It&#8217;s available
here: <a class="reference external" href="http://github.com/arskom/rpclib/blob/master/examples/user_manager/server_basic.py">http://github.com/arskom/rpclib/blob/master/examples/user_manager/server_basic.py</a></p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;rpclib.protocol.soap.soap11&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">rpclib.application</span> <span class="kn">import</span> <span class="n">Application</span>
<span class="kn">from</span> <span class="nn">rpclib.decorator</span> <span class="kn">import</span> <span class="n">rpc</span>
<span class="kn">from</span> <span class="nn">rpclib.interface.wsdl</span> <span class="kn">import</span> <span class="n">Wsdl11</span>
<span class="kn">from</span> <span class="nn">rpclib.protocol.soap</span> <span class="kn">import</span> <span class="n">Soap11</span>
<span class="kn">from</span> <span class="nn">rpclib.model.primitive</span> <span class="kn">import</span> <span class="n">String</span>
<span class="kn">from</span> <span class="nn">rpclib.model.primitive</span> <span class="kn">import</span> <span class="n">Integer</span>
<span class="kn">from</span> <span class="nn">rpclib.model.complex</span> <span class="kn">import</span> <span class="n">Array</span>
<span class="kn">from</span> <span class="nn">rpclib.model.complex</span> <span class="kn">import</span> <span class="n">Iterable</span>
<span class="kn">from</span> <span class="nn">rpclib.model.complex</span> <span class="kn">import</span> <span class="n">ComplexModel</span>
<span class="kn">from</span> <span class="nn">rpclib.server.wsgi</span> <span class="kn">import</span> <span class="n">WsgiApplication</span>
<span class="kn">from</span> <span class="nn">rpclib.service</span> <span class="kn">import</span> <span class="n">ServiceBase</span>

<span class="n">_user_database</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">_user_id_seq</span> <span class="o">=</span> <span class="mi">1</span>

<span class="k">class</span> <span class="nc">Permission</span><span class="p">(</span><span class="n">ComplexModel</span><span class="p">):</span>
    <span class="n">__namespace__</span> <span class="o">=</span> <span class="s">&#39;rpclib.examples.user_manager&#39;</span>

    <span class="n">application</span> <span class="o">=</span> <span class="n">String</span>
    <span class="n">operation</span> <span class="o">=</span> <span class="n">String</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">ComplexModel</span><span class="p">):</span>
    <span class="n">__namespace__</span> <span class="o">=</span> <span class="s">&#39;rpclib.examples.user_manager&#39;</span>

    <span class="n">user_id</span> <span class="o">=</span> <span class="n">Integer</span>
    <span class="n">user_name</span> <span class="o">=</span> <span class="n">String</span>
    <span class="n">first_name</span> <span class="o">=</span> <span class="n">String</span>
    <span class="n">last_name</span> <span class="o">=</span> <span class="n">String</span>
    <span class="n">permissions</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">Permission</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">UserManagerService</span><span class="p">(</span><span class="n">ServiceBase</span><span class="p">):</span>
    <span class="nd">@rpc</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">_returns</span><span class="o">=</span><span class="n">Integer</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">add_user</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="n">user</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">udc</span><span class="o">.</span><span class="n">get_next_user_id</span><span class="p">()</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">udc</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">user_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span>

        <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">user_id</span>

    <span class="nd">@rpc</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">_returns</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_user</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">udc</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span>

    <span class="nd">@rpc</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">set_user</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">udc</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">user_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span>

    <span class="nd">@rpc</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">del_user</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
        <span class="k">del</span> <span class="n">ctx</span><span class="o">.</span><span class="n">udc</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span>

    <span class="nd">@rpc</span><span class="p">(</span><span class="n">_returns</span><span class="o">=</span><span class="n">Iterable</span><span class="p">(</span><span class="n">User</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">get_all_users</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">udc</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">itervalues</span><span class="p">()</span>

<span class="n">application</span> <span class="o">=</span> <span class="n">Application</span><span class="p">([</span><span class="n">UserManagerService</span><span class="p">],</span> <span class="s">&#39;rpclib.examples.user_manager&#39;</span><span class="p">,</span>
            <span class="n">interface</span><span class="o">=</span><span class="n">Wsdl11</span><span class="p">(),</span> <span class="n">in_protocol</span><span class="o">=</span><span class="n">Soap11</span><span class="p">(),</span> <span class="n">out_protocol</span><span class="o">=</span><span class="n">Soap11</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">_on_method_call</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">udc</span> <span class="o">=</span> <span class="n">UserDefinedContext</span><span class="p">()</span>

<span class="n">application</span><span class="o">.</span><span class="n">event_manager</span><span class="o">.</span><span class="n">add_listener</span><span class="p">(</span><span class="s">&#39;method_call&#39;</span><span class="p">,</span> <span class="n">_on_method_call</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">UserDefinedContext</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="n">_user_database</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_next_user_id</span><span class="p">():</span>
        <span class="k">global</span> <span class="n">_user_id_seq</span>

        <span class="n">_user_id_seq</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">_user_id_seq</span>

<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">wsgiref.simple_server</span> <span class="kn">import</span> <span class="n">make_server</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;Error: example server code requires Python &gt;= 2.5&quot;</span>

    <span class="n">server</span> <span class="o">=</span> <span class="n">make_server</span><span class="p">(</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">7789</span><span class="p">,</span> <span class="n">WsgiApplication</span><span class="p">(</span><span class="n">application</span><span class="p">))</span>

    <span class="k">print</span> <span class="s">&quot;listening to http://127.0.0.1:7789&quot;</span>
    <span class="k">print</span> <span class="s">&quot;wsdl is at: http://localhost:7789/?wsdl&quot;</span>

    <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</pre></div>
</div>
<p>Jumping into what&#8217;s new.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Permission</span><span class="p">(</span><span class="n">ComplexModel</span><span class="p">):</span>
    <span class="n">application</span> <span class="o">=</span> <span class="n">String</span>
    <span class="n">feature</span> <span class="o">=</span> <span class="n">String</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">ComplexModel</span><span class="p">):</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">Integer</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">String</span>
    <span class="n">firstname</span> <span class="o">=</span> <span class="n">String</span>
    <span class="n">lastname</span> <span class="o">=</span> <span class="n">String</span>
    <span class="n">permissions</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">Permission</span><span class="p">)</span>
</pre></div>
</div>
<p>The <cite>Permission</cite> and <cite>User</cite> structures in the example are standard python
objects that extend <cite>ComplexModel</cite>.  Rpclib uses <cite>ComplexModel</cite> as a general
type that when extended will produce complex serializable types that can be used
in a public service.</p>
<p>Here, we define a function to be called for every method call. It instantiates
an object called UserDefinedContext and sets it to the context object&#8217;s udc
attribute, which is in fact short for &#8216;user defined context&#8217;.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">_on_method_call</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">udc</span> <span class="o">=</span> <span class="n">UserDefinedContext</span><span class="p">()</span>
</pre></div>
</div>
<p>We register it to the application&#8217;s &#8216;method_call&#8217; handler.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">application</span><span class="o">.</span><span class="n">event_manager</span><span class="o">.</span><span class="n">add_listener</span><span class="p">(</span><span class="s">&#39;method_call&#39;</span><span class="p">,</span> <span class="n">_on_method_call</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that registering it to the service definition&#8217;s event manager would have
the same effect:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">UserManagerService</span><span class="o">.</span><span class="n">event_manager</span><span class="o">.</span><span class="n">add_listener</span><span class="p">(</span><span class="s">&#39;method_call&#39;</span><span class="p">,</span> <span class="n">_on_method_call</span><span class="p">)</span>
</pre></div>
</div>
<p>Here, we define the UserDefinedContext object. It&#8217;s just a regular python class
with no specific api it should adhere to, other than your own.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UserDefinedContext</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="n">_user_database</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_next_user_id</span><span class="p">():</span>
        <span class="k">global</span> <span class="n">_user_id_seq</span>

        <span class="n">_user_id_seq</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">_user_id_seq</span>
</pre></div>
</div>
<p>Such custom objects could be used to manage everything from transactions to
logging or to performance measurements. (see the events.py example in the
examples directory in the source distribution for an example on using events to
measure method performance.</p>
<div class="section" id="what-s-next">
<h2>What&#8217;s next?<a class="headerlink" href="#what-s-next" title="Permalink to this headline">Â¶</a></h2>
<p>This tutorial walks you through most of what you need to know to expose your
services. You can read the SQLAlchemy &amp; Rpclib integration tutorial if you plan
to expose your database application using rpclib. Otherwise, you should refer to
the rest of the documentation or the mailing list if you have further questions.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">User Manager</a><ul>
<li><a class="reference internal" href="#what-s-next">What&#8217;s next?</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="helloworld.html"
                        title="previous chapter">Hello World</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="sqlalchemy.html"
                        title="next chapter">SQLAlchemy Integration</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../sources/tutorial/usermanager.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="sqlalchemy.html" title="SQLAlchemy Integration"
             >next</a> |</li>
        <li class="right" >
          <a href="helloworld.html" title="Hello World"
             >previous</a> |</li>
        <li><a href="../index.html">rpclib v2.3.1-beta documentation</a> &raquo;</li>
          <li><a href="index.html" >Rpclib Tutorials</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, Rpclib Contributors.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.7.
    </div>
  </body>
</html>